<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Results</title>
    <style>
      * { margin: 0; padding: 0; box-sizing: border-box; }

      body {
        background-color: #061528;
        display: flex;
        align-items: center;
        justify-content: center;
        min-height: 100vh;
        font-family: Arial, sans-serif;
      }

      #loading-screen {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 32px;
      }

      #loading-screen img {
        width: 160px;
        opacity: 0.95;
      }

      .spinner {
        width: 44px;
        height: 44px;
        border: 3px solid rgba(216, 183, 67, 0.2);
        border-top-color: #D8B743;
        border-radius: 50%;
        animation: spin 0.8s linear infinite;
      }

      #status-error {
        display: none;
        color: #E1E4E9;
        font-size: 0.9rem;
        text-align: center;
        max-width: 300px;
        line-height: 1.5;
      }

      @keyframes spin {
        to { transform: rotate(360deg); }
      }
    </style>
  </head>
  <body>
    <div id="loading-screen">
      <img src="/public/bg-logo.png" alt="HumTech" />
      <div class="spinner" id="spinner"></div>
      <p id="status-error"></p>
    </div>

    <script>
      const params = new URLSearchParams(window.location.search);
      const submission = params.get("submission");

      if (!submission) {
        document.getElementById("spinner").style.display = "none";
        const err = document.getElementById("status-error");
        err.style.display = "block";
        err.textContent = "Missing submission query parameter.";
      } else {
        fetch(`/api/results?submission=${encodeURIComponent(submission)}`)
          .then(async (response) => {
            let html = await response.text();
            if (!response.ok) {
              throw new Error(html || "Request failed");
            }
            if (!html) {
              throw new Error("No HTML returned");
            }
            // Ensure viewport meta exists
            if (!html.includes('name="viewport"')) {
              html = html.replace(
                /<head>/i,
                '<head><meta name="viewport" content="width=device-width, initial-scale=1">'
              );
            }

            // Inject mobile overflow fixes
            const injectStyles = `<style>
              *, *::before, *::after { box-sizing: border-box; }
              html, body { overflow-x: hidden; max-width: 100%; }
              img, video, iframe, table, pre { max-width: 100% !important; height: auto; }
              td, th { word-break: break-word; }

              @media (max-width: 640px) {
                .page { padding: 12px !important; gap: 10px !important; }

                /* Header stacks vertically */
                .header { flex-direction: column !important; gap: 16px !important; }
                .header-right { text-align: left !important; align-items: flex-start !important; }
                .score-block { justify-content: flex-start !important; }
                .score-num { font-size: 36px !important; }

                /* Pillar grid: 5 cols → 2 cols */
                .pillar-stat-grid { grid-template-columns: 1fr 1fr !important; }
                .pillar-stat { border-right: 1px solid rgba(25,48,80,0.10) !important; }
                .pillar-stat:nth-child(2n) { border-right: none !important; }
                .pillar-stat:last-child:nth-child(odd) { grid-column: 1 / -1 !important; }

                /* Waterfall: hide bar column */
                .wf-row { grid-template-columns: 26px 1fr 80px !important; }
                .wf-bar-col { display: none !important; }
                .wf-amount { font-size: 12px !important; }

                /* Qual grid: 2 cols → 1 col */
                .qual-grid { grid-template-columns: 1fr !important; }
                .qual-item { border-right: none !important; }
                .qual-item:last-child:nth-child(odd) {
                  grid-column: auto !important;
                  grid-template-columns: 1fr !important;
                  gap: 0 !important;
                }

                /* Waterfall summary strip: 3 cols → 1 col */
                .wf-summary-strip { grid-template-columns: 1fr !important; }
                .wf-stat { border-right: none !important; border-top: 1px solid rgba(25,48,80,0.10) !important; }
              }
            </style>`;

            html = html.replace(/<\/head>/i, injectStyles + '</head>');

            document.open();
            document.write(html);
            document.close();
          })
          .catch((error) => {
            document.getElementById("spinner").style.display = "none";
            const err = document.getElementById("status-error");
            err.style.display = "block";
            err.textContent = `Error: ${error.message}`;
          });
      }
    </script>
  </body>
</html>
